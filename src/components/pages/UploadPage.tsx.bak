import { useState } from 'react';
import { BaseCrudService } from '@/integrations';
import { ProjectReports } from '@/entities';
import { Upload, FileText, CheckCircle, AlertCircle, Loader } from 'lucide-react';
import { motion } from 'framer-motion';
import { format } from 'date-fns';
import { saveOrUpdateProject } from '@/lib/project-service';
import Header from '@/components/Header';
import Footer from '@/components/Footer';

// API base (use Vite env in dev, fallback to local backend)
const API_BASE = (import.meta as any)?.env?.VITE_API_BASE || 'http://127.0.0.1:5002';
interface AnalysisResult {
  projectId?: string;
  project_info: {
    full_name: string;
    code: string;
    customer?: string;
    report_period: string;
    location?: string;
  };
  project_status: '–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π' | '—Ç—Ä–µ–≤–æ–∂–Ω—ã–π' | '–∫—Ä–∏—Ç–∏—á–Ω—ã–π';
  metrics: {
    SMR_completion?: number;
    GPR_delay_percent?: number;
    GPR_delay_days?: number;
    DDU_payments_percent?: number[];
    guarantee_extension?: boolean;
  };
  reasoning: string[];
  triggered_conditions: string[];
}

export default function UploadPage() {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [uploadStatus, setUploadStatus] = useState<'idle' | 'uploading' | 'success' | 'error'>('idle');
  const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);
  const [recentReports, setRecentReports] = useState<ProjectReports[]>([]);
  const [dragActive, setDragActive] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const [needs3ReportsFlag, setNeeds3ReportsFlag] = useState(false);
  const [manualProjectName, setManualProjectName] = useState('');
  const [projectSaved, setProjectSaved] = useState(false);
  const [savingProject, setSavingProject] = useState(false);

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º (–ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
  const handleSaveProject = async () => {
    if (!analysisResult) return;

    setSavingProject(true);
    try {
      const projectSaveResult = await saveOrUpdateProject(analysisResult, {
        fileName: selectedFile?.name || 'untitled.pdf',
        uploadedAt: new Date().toISOString(),
        projectName: analysisResult.project_info.full_name,
      });
      console.log('‚úì Project saved with name:', analysisResult.project_info.full_name);
      console.log('Project saved/updated:', projectSaveResult);
      setProjectSaved(true);
    } catch (err) {
      console.error('Failed to save project:', err);
      setErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
    } finally {
      setSavingProject(false);
    }
  };

  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      const file = files[0];
      if (file.type === 'application/pdf') {
        setSelectedFile(file);
        setErrorMessage('');
      } else {
        setErrorMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª');
      }
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      if (file.type === 'application/pdf') {
        setSelectedFile(file);
        setErrorMessage('');
      } else {
        setErrorMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª');
      }
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!selectedFile) {
      setErrorMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
      return;
    }

    setUploadStatus('uploading');
    setErrorMessage('');

    try {
      const formData = new FormData();
      formData.append('file', selectedFile);

      console.log('Sending request to:', `${API_BASE}/api/analyze-report`);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å timeout 45 —Å–µ–∫—É–Ω–¥
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 45000);

      const response = await fetch(`${API_BASE}/api/analyze-report`, {
        method: 'POST',
        body: formData,
        signal: controller.signal,
      }).catch(err => {
        clearTimeout(timeoutId);
        if (err.name === 'AbortError') {
          throw new Error('–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞.');
        }
        throw err;
      });

      clearTimeout(timeoutId);
      console.log('Response status:', response.status, response.statusText);

      if (!response.ok && response.status !== 200) {
        const text = await response.text().catch(() => 'Unknown error');
        console.error('API returned non-OK:', response.status, response.statusText, text);
        
        try {
          const errorData = JSON.parse(text);
          throw new Error(errorData.error || `API error: ${response.status}`);
        } catch (e) {
          throw new Error(`API error: ${response.status}`);
        }
      }

      // –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∏ –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–∑–∞—â–∏—Ç–Ω–æ–µ –ø–∞—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)
      const respText = await response.text();
      let result;
      try {
        result = JSON.parse(respText);
        console.debug('Analyzer response:', result);
        console.log('ProjectId from backend:', result?.projectId);
        console.log('Code from backend:', result?.project_info?.code);
        setAnalysisResult(result);
        // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ
        if (result && result.require_manual_name) {
          setManualProjectName('');
        }
      } catch (parseErr) {
        console.error('Failed to parse analyzer response as JSON:', parseErr, respText);
        throw new Error('Invalid JSON response from analyzer');
      }

      // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–µ–∫—Ç —Å—Ä–∞–∑—É! –î–æ–∂–¥–µ–º—Å—è –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥—ë—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ
      setProjectSaved(false);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      // –ù–∞–¥—ë–∂–Ω—ã–π id: fallback –µ—Å–ª–∏ crypto.randomUUID –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å—Ä–µ–¥–µ
      const reportId = (typeof crypto !== 'undefined' && (crypto as any).randomUUID)
        ? (crypto as any).randomUUID()
        : `id-${Date.now()}-${Math.floor(Math.random() * 1e6)}`;

      const newReport: ProjectReports = {
        _id: reportId,
        reportFileName: selectedFile.name,
        uploadDate: new Date().toISOString(),
        processingStatus: 'Completed',
        ingestionLog: `–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω: –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ - ${result.project_status}. ${result.project_info.full_name}`,
        analysisResult: result,  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
      };

      try {
        await BaseCrudService.create('projectreports', newReport);
        console.log('Project report saved successfully:', reportId);
      } catch (dbErr) {
        console.error('Failed to save project report to DB:', dbErr);
        console.warn('Continuing despite DB error - analysis result already displayed');
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—à–ª–æ
      }

      setUploadStatus('success');
      setSelectedFile(null);

      // If analyzer returned needs3Reports, surface a prominent UI hint
      if (result?.needs3Reports) {
        setNeeds3ReportsFlag(true);
      } else {
        setNeeds3ReportsFlag(false);
      }

      // Load recent reports - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É–¥–∞–µ—Ç—Å—è
      try {
        const resultReports = await BaseCrudService.getAll<ProjectReports>('projectreports', [], { limit: 5 });
        const sorted = resultReports.items.sort((a, b) => {
          const dateA = a.uploadDate ? new Date(a.uploadDate).getTime() : 0;
          const dateB = b.uploadDate ? new Date(b.uploadDate).getTime() : 0;
          return dateB - dateA;
        });
        setRecentReports(sorted);
      } catch (reportsErr) {
        console.error('Failed to load recent reports:', reportsErr);
      }

      setTimeout(() => setUploadStatus('idle'), 5000);
    } catch (error) {
      console.error('Error analyzing report:', error);
      setUploadStatus('error');
      const errorMsg = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      setErrorMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—á–µ—Ç–∞: ${errorMsg}`);
      setTimeout(() => setUploadStatus('idle'), 3000);
    }
  };

  const getStatusIcon = (status: string) => {
    const icons: Record<string, React.ReactNode> = {
      '–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π': 'üü¢',
      '—Ç—Ä–µ–≤–æ–∂–Ω—ã–π': 'üü°',
      '–∫—Ä–∏—Ç–∏—á–Ω—ã–π': 'üî¥'
    };
    return icons[status] || '‚ùì';
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />

      <main className="w-full">
        <section className="w-full max-w-[100rem] mx-auto px-8 lg:px-16 pt-16 pb-12">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
          >
            <h1 className="font-heading text-5xl text-deep-black mb-4">
              –ó–∞–≥—Ä—É–∑–∏—Ç—å –û—Ç—á—ë—Ç—ã –ü—Ä–æ–µ–∫—Ç–æ–≤
            </h1>
            <p className="font-paragraph text-lg text-medium-grey">
              –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ PDF-–æ—Ç—á—ë—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –æ—Ü–µ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞
            </p>
          </motion.div>
        </section>

        <section className="w-full max-w-[100rem] mx-auto px-8 lg:px-16 pb-20">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
            {/* Upload Form */}
            <motion.div
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ duration: 0.6, delay: 0.2 }}
            >
              <div className="bg-white p-10 rounded-lg border border-light-grey">
                <div className="flex items-center gap-3 mb-8">
                  <Upload className="w-6 h-6 text-primary" />
                  <h2 className="font-heading text-3xl text-deep-black">
                    –ê–Ω–∞–ª–∏–∑ –û—Ç—á—ë—Ç–∞
                  </h2>
                </div>

                <form onSubmit={handleSubmit} className="space-y-6">
                  {/* Drag and Drop Area */}
                  <div
                    onDragEnter={handleDrag}
                    onDragLeave={handleDrag}
                    onDragOver={handleDrag}
                    onDrop={handleDrop}
                    className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${
                      dragActive
                        ? 'border-primary bg-primary/5'
                        : 'border-light-grey hover:border-primary'
                    }`}
                  >
                    <Upload className="w-12 h-12 text-medium-grey mx-auto mb-4" />
                    <p className="font-paragraph text-base text-foreground mb-2">
                      –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∞—à PDF –æ—Ç—á–µ—Ç —Å—é–¥–∞
                    </p>
                    <p className="font-paragraph text-sm text-medium-grey mb-4">
                      –∏–ª–∏ —â–µ–ª–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
                    </p>
                    <label className="cursor-pointer">
                      <input
                        type="file"
                        accept=".pdf"
                        onChange={handleFileChange}
                        className="hidden"
                      />
                      <span className="inline-block px-8 py-3 border border-primary text-primary font-paragraph text-base rounded-md hover:text-accent-gold hover:border-accent-gold transition-colors">
                        Choose File
                      </span>
                    </label>
                  </div>

                  {/* Selected File Display */}
                  {selectedFile && (
                    <div className="p-4 bg-background rounded-lg border border-light-grey">
                      <p className="font-paragraph text-sm text-foreground font-medium">
                        –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:
                      </p>
                      <p className="font-paragraph text-base text-deep-black">
                        {selectedFile.name}
                      </p>
                      <p className="font-paragraph text-xs text-medium-grey mt-2">
                        {(selectedFile.size / 1024 / 1024).toFixed(2)} –ú–ë
                      </p>
                    </div>
                  )}

                  {/* Error Message */}
                  {errorMessage && (
                    <motion.div
                      initial={{ opacity: 0, y: -10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="flex items-center gap-3 p-4 bg-warning-red/10 rounded-lg border border-warning-red"
                    >
                      <AlertCircle className="w-5 h-5 text-warning-red flex-shrink-0" />
                      <p className="font-paragraph text-sm text-warning-red">
                        {errorMessage}
                      </p>
                    </motion.div>
                  )}

                  {/* Submit Button */}
                  <div className="pt-4">
                    <button
                      type="submit"
                      disabled={!selectedFile || uploadStatus === 'uploading'}
                      className="w-full px-8 py-4 border border-primary text-primary font-paragraph text-base rounded-md hover:text-accent-gold hover:border-accent-gold transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {uploadStatus === 'uploading' && (
                        <Loader className="w-5 h-5 animate-spin" />
                      )}
                      {uploadStatus === 'uploading' ? '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∏–µ...' : '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –û—Ç—á—ë—Ç'}
                    </button>
                  </div>

                  {uploadStatus === 'success' && (
                    <motion.div
                      initial={{ opacity: 0, y: -10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="flex items-center gap-3 p-4 bg-success-green/10 rounded-lg border border-success-green"
                    >
                      <CheckCircle className="w-5 h-5 text-success-green flex-shrink-0" />
                      <p className="font-paragraph text-sm text-success-green">
                        –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!
                      </p>
                    </motion.div>
                  )}

                  {uploadStatus === 'error' && !errorMessage && (
                    <motion.div
                      initial={{ opacity: 0, y: -10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="flex items-center gap-3 p-4 bg-warning-red/10 rounded-lg border border-warning-red"
                    >
                      <AlertCircle className="w-5 h-5 text-warning-red flex-shrink-0" />
                      <p className="font-paragraph text-sm text-warning-red">
                        –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—á—ë—Ç–∞. –ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –µ—â—ë —Ä–∞–∑.
                      </p>
                    </motion.div>
                  )}
                </form>
              </div>

              {/* Instructions */}
              <div className="bg-background p-8 rounded-lg mt-8">
                <h3 className="font-heading text-xl text-deep-black mb-4">
                  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ó–∞–≥—Ä—É–∑–∫–µ
                </h3>
                <ul className="space-y-3">
                  <li className="flex items-start gap-3">
                    <span className="font-paragraph text-base text-accent-gold mt-1">‚Ä¢</span>
                    <p className="font-paragraph text-base text-foreground">
                      –û—Ç—á—ë—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF
                    </p>
                  </li>
                  <li className="flex items-start gap-3">
                    <span className="font-paragraph text-base text-accent-gold mt-1">‚Ä¢</span>
                    <p className="font-paragraph text-base text-foreground">
                      –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ –∏ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
                    </p>
                  </li>
                  <li className="flex items-start gap-3">
                    <span className="font-paragraph text-base text-accent-gold mt-1">‚Ä¢</span>
                    <p className="font-paragraph text-base text-foreground">
                      –¢–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, —Ç—Ä–µ–≤–æ–∂–Ω—ã–π, –∫—Ä–∏—Ç–∏—á–Ω—ã–π)
                    </p>
                  </li>
                  <li className="flex items-start gap-3">
                    <span className="font-paragraph text-base text-accent-gold mt-1">‚Ä¢</span>
                    <p className="font-paragraph text-base text-foreground">
                      –ò–∑–≤–ª–µ–∫–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –°–ú–†, –∑–∞–¥–µ—Ä–∂–∫–∞ –ì–ü–†, –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –î–î–£, –≥–∞—Ä–∞–Ω—Ç–∏–∏
                    </p>
                  </li>
                </ul>
              </div>
            </motion.div>

            {/* Analysis Results / Recent Reports */}
            <motion.div
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ duration: 0.6, delay: 0.3 }}
            >
              {analysisResult ? (
                <div className="bg-white p-10 rounded-lg border border-light-grey">
                  {needs3ReportsFlag && (
                    <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                      <strong>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö:</strong> –î–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—É–Ω–∫—Ç–∞ B6 —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞. –ü–æ–∫–∞ –æ—Ü–µ–Ω–∫–∞ B6 –æ—Ç–ª–æ–∂–µ–Ω–∞.
                    </div>
                  )}
                  <div className="flex items-center gap-3 mb-8">
                    <FileText className="w-6 h-6 text-primary" />
                    <h2 className="font-heading text-3xl text-deep-black">
                      –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ê–Ω–∞–ª–∏–∑–∞
                    </h2>
                  </div>

                  <div className="space-y-6">
                    {/* Project Info */}
                    <div className="border-b border-light-grey pb-6">
                      <h3 className="font-heading text-lg text-deep-black mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ü—Ä–æ–µ–∫—Ç–µ</h3>
                      <div className="space-y-2">
                        <div>
                          <p className="font-paragraph text-xs text-medium-grey uppercase tracking-wide">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</p>
                          {analysisResult.require_manual_name ? (
                            <div className="flex gap-2 items-end">
                              <div className="flex-1">
                                <input
                                  type="text"
                                  className="font-paragraph text-base text-foreground border border-light-grey rounded px-2 py-1 w-full"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
                                  value={manualProjectName}
                                  onChange={e => {
                                    setManualProjectName(e.target.value);
                                    // –û–±–Ω–æ–≤–ª—è–µ–º analysisResult.project_info.full_name –Ω–∞ –ª–µ—Ç—É
                                    setAnalysisResult(prev => prev ? {
                                      ...prev,
                                      project_info: {
                                        ...prev.project_info,
                                        full_name: e.target.value
                                      }
                                    } : prev);
                                  }}
                                />
                              </div>
                              <button
                                onClick={() => {
                                  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ - –æ–Ω–æ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ analysisResult
                                  alert('‚úì –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞ –æ–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ –ø—Ä–æ–µ–∫—Ç—É.');
                                }}
                                className="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition-colors text-sm font-semibold"
                              >
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                              </button>
                            </div>
                          ) : (
                            <p className="font-paragraph text-base text-foreground">
                              {analysisResult.project_info.full_name}
                            </p>
                          )}
                        </div>
                        <div>
                          <p className="font-paragraph text-xs text-medium-grey uppercase tracking-wide">–ö–æ–¥</p>
                          <p className="font-paragraph text-base text-foreground">
                            {analysisResult.project_info.code}
                          </p>
                        </div>
                        <div>
                          <p className="font-paragraph text-xs text-medium-grey uppercase tracking-wide">–ü–µ—Ä–∏–æ–¥</p>
                          <p className="font-paragraph text-base text-foreground">
                            {analysisResult.project_info.report_period}
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Project Status */}
                    <div className="border-b border-light-grey pb-6">
                      <h3 className="font-heading text-lg text-deep-black mb-3">–°—Ç–∞—Ç—É—Å –ü—Ä–æ–µ–∫—Ç–∞</h3>
                      <div className="p-4 bg-background rounded-lg text-center">
                        <p className="font-heading text-4xl mb-2">
                          {getStatusIcon(analysisResult.project_status)}
                        </p>
                        <p className="font-heading text-2xl text-deep-black capitalize mb-2">
                          {analysisResult.project_status}
                        </p>
                      </div>
                    </div>

                    {/* Key Metrics */}
                    {(analysisResult.metrics.SMR_completion !== undefined ||
                      analysisResult.metrics.GPR_delay_percent !== undefined ||
                      analysisResult.metrics.DDU_payments_percent) && (
                      <div className="border-b border-light-grey pb-6">
                        <h3 className="font-heading text-lg text-deep-black mb-3">–ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏</h3>
                        <div className="space-y-2">
                          {typeof analysisResult.metrics.SMR_completion === 'number' && (
                            <div className="flex justify-between">
                              <span className="font-paragraph text-sm text-foreground">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –°–ú–†</span>
                              <span className="font-paragraph text-sm font-medium text-deep-black">
                                {analysisResult.metrics.SMR_completion.toFixed(2)}%
                              </span>
                            </div>
                          )}
                          {analysisResult.metrics.GPR_delay_days !== undefined && (
                            <div className="flex justify-between">
                              <span className="font-paragraph text-sm text-foreground">–û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –ì–ü–†</span>
                              <span className="font-paragraph text-sm font-medium text-deep-black">
                                {analysisResult.metrics.GPR_delay_days} –¥–Ω–µ–π
                              </span>
                            </div>
                          )}
                          {(() => {
                            const dduVal = analysisResult.metrics.DDU_payments_percent?.[0];
                            return typeof dduVal === 'number' ? (
                              <div className="flex justify-between">
                                <span className="font-paragraph text-sm text-foreground">–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –î–î–£</span>
                                <span className="font-paragraph text-sm font-medium text-deep-black">
                                  {dduVal.toFixed(2)}%
                                </span>
                              </div>
                            ) : null;
                          })()}
                        </div>
                      </div>
                    )}

                    {/* Reasoning */}
                    {analysisResult.reasoning && analysisResult.reasoning.length > 0 && (
                      <div>
                        <h3 className="font-heading text-lg text-deep-black mb-3">–î–µ—Ç–∞–ª–∏ –ê–Ω–∞–ª–∏–∑–∞</h3>
                        <div className="space-y-2 text-sm">
                          {analysisResult.reasoning.map((reason, idx) => (
                            <p key={idx} className="font-paragraph text-foreground">
                              {reason}
                            </p>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="bg-white p-10 rounded-lg border border-light-grey">
                  <div className="flex items-center gap-3 mb-8">
                    <FileText className="w-6 h-6 text-primary" />
                    <h2 className="font-heading text-3xl text-deep-black">
                      –ù–µ–¥–∞–≤–Ω–∏–µ –ó–∞–≥—Ä—É–∑–∫–∏
                    </h2>
                  </div>

                  {recentReports.length === 0 ? (
                    <p className="font-paragraph text-base text-medium-grey text-center py-12">
                      –û—Ç—á—ë—Ç—ã –µ—â—ë –Ω–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –ó–∞–≥—Ä—É–∂–µ–Ω —Ç–µ –ø–µ—Ä–≤—ã–π –æ—Ç—á—ë—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.
                    </p>
                  ) : (
                    <div className="space-y-4">
                      {recentReports.map((report, index) => (
                        <motion.button
                          key={report._id}
                          initial={{ opacity: 0, y: 10 }}
                          animate={{ opacity: 1, y: 0 }}
                          transition={{ duration: 0.3, delay: index * 0.1 }}
                          onClick={() => {
                            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –æ—Ç—á–µ—Ç–∞
                            if (report.analysisResult) {
                              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤ sessionStorage —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ–µ–∫—Ç–∞
                              sessionStorage.setItem(`project-${report._id}`, JSON.stringify(report.analysisResult));
                              window.location.href = `/projects/${report._id}`;
                            }
                          }}
                          className="w-full text-left p-6 bg-background rounded-lg border border-light-grey hover:border-primary hover:shadow-lg transition-all cursor-pointer"
                        >
                          <div className="flex items-start justify-between mb-3">
                            <h3 className="font-paragraph text-base text-deep-black max-w-[70%] break-words">
                              {report.reportFileName}
                            </h3>
                            <span
                              className={`font-paragraph text-xs px-3 py-1 rounded-full flex-shrink-0 ml-2 ${
                                report.processingStatus === 'Completed'
                                  ? 'bg-success-green text-success-green-foreground'
                                  : report.processingStatus === 'Processing'
                                  ? 'bg-primary text-primary-foreground'
                                  : 'bg-light-grey text-foreground'
                              }`}
                            >
                              {report.processingStatus}
                            </span>
                          </div>
                          {report.uploadDate && (
                            <p className="font-paragraph text-sm text-medium-grey mb-2">
                              {format(new Date(report.uploadDate), 'MMMM d, yyyy ‚Ä¢ HH:mm')}
                            </p>
                          )}
                          {report.ingestionLog && (
                            <p className="font-paragraph text-sm text-foreground">
                              {report.ingestionLog}
                            </p>
                          )}
                        </motion.button>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </motion.div>
          </div>
        </section>
      </main>

      <Footer />
    </div>
  );
}
