# 🚀 Интеграция PDF Analysis в Build View Hub

## 📌 Быстрый старт (5 минут)

### 1️⃣ Установить зависимости
```bash
pip install -r requirements-backend.txt
```

### 2️⃣ Запустить Backend
```bash
python3 api.py
```
✅ Сервер запустится на `http://localhost:5000`

### 3️⃣ Запустить Frontend (в отдельном терминале)
```bash
npm run dev
```
✅ Приложение откроется на `http://localhost:5173`

### 4️⃣ Открыть страницу загрузки
1. Перейти на `Upload Project Reports`
2. Загрузить PDF (например, `2.pdf`)
3. Нажать "Analyze Report"
4. 🎉 Готово! Получить результаты анализа

---

## 📚 Документация

| Документ | Описание |
|----------|---------|
| [INTEGRATION_SUMMARY.md](INTEGRATION_SUMMARY.md) | Полная сводка всех изменений |
| [BACKEND_SETUP.md](BACKEND_SETUP.md) | Детальная конфигурация Backend |
| [PDF_ANALYSIS_GUIDE.md](PDF_ANALYSIS_GUIDE.md) | Руководство пользователя |
| [USAGE_EXAMPLES.md](USAGE_EXAMPLES.md) | Примеры кода и интеграции |

---

## 🎯 Что изменилось

### Frontend (UploadPage.tsx)
✅ Замена текстовых полей на **drag-and-drop**  
✅ Загрузка **PDF файлов**  
✅ Отображение **результатов анализа в реальном времени**  
✅ Классификация статуса проекта  

### Backend (api.py)
✅ Flask API сервер  
✅ Endpoint POST `/api/analyze-report`  
✅ Интеграция с `advanced_analyzer.py`  
✅ Валидация файлов и обработка ошибок  

### Анализатор (advanced_analyzer.py)
✅ Извлечение метрик из PDF  
✅ Классификация статуса проекта  
✅ Подробное обоснование результатов  

---

## 📊 Процесс анализа

```
┌─────────────────────────────────────────┐
│   Пользователь загружает PDF файл       │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   Frontend валидирует файл               │
│   (проверка размера и типа)             │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   POST /api/analyze-report               │
│   Content-Type: multipart/form-data     │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   Backend обрабатывает файл             │
│   - Сохраняет временно                  │
│   - Запускает анализатор                │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   AdvancedReportAnalyzer                │
│   - Извлекает текст из PDF              │
│   - Ищет метрики по regex               │
│   - Классифицирует статус               │
│   - Генерирует обоснование              │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   API возвращает JSON:                  │
│   {                                     │
│     project_info: {...},                │
│     project_status: "тревожный",        │
│     metrics: {...},                     │
│     reasoning: [...]                    │
│   }                                     │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   Frontend отображает результаты:       │
│   - Информацию о проекте                │
│   - Статус с иконкой (🟢/🟡/🔴)        │
│   - Ключевые метрики                    │
│   - Обоснование классификации           │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│   Сохранить в базе данных               │
│   (projectreports коллекция)            │
└─────────────────────────────────────────┘
```

---

## 📦 Файловая структура

```
build-view-hub-main/
├── 📄 api.py                          ← Flask API сервер (NEW)
├── 📄 advanced_analyzer.py            ← Анализатор PDF
├── 📄 requirements-backend.txt        ← Python зависимости (NEW)
│
├── 📚 Документация (NEW):
├── 📄 INTEGRATION_SUMMARY.md          ← Краткая сводка
├── 📄 BACKEND_SETUP.md                ← Конфигурация Backend
├── 📄 PDF_ANALYSIS_GUIDE.md           ← Руководство пользователя
├── 📄 USAGE_EXAMPLES.md               ← Примеры кода
│
└── src/
    └── components/pages/
        └── UploadPage.tsx             ← Обновленный компонент
```

---

## 🔌 API Контракт

### POST /api/analyze-report
Загрузить и проанализировать PDF отчет

**Request:**
```bash
curl -X POST http://localhost:5000/api/analyze-report \
  -F "file=@report.pdf"
```

**Response (200 OK):**
```json
{
  "project_info": {
    "full_name": "ЖК JM City Dom-Park",
    "code": "Сертификат №134, ДПГ-21-01-039/098",
    "report_period": "2025г декабря",
    "location": "город Нурсултан"
  },
  "project_status": "тревожный",
  "metrics": {
    "SMR_completion": 46.69,
    "GPR_delay_percent": 13.33,
    "GPR_delay_days": 76,
    "DDU_payments_percent": [47.07],
    "guarantee_extension": true
  },
  "reasoning": [
    "🟡 СТАТУС: ТРЕВОЖНЫЙ - Выполнены условия...",
    "✓ Условие 'a' ВЫПОЛНЕНО: СМР 46.69% < 80%",
    "✗ Условие 'b1' НЕ ВЫПОЛНЕНО: Отставание 13.33% <= 30%",
    "✓ Условие 'b6' ВЫПОЛНЕНО: Поступления по ДДУ 47.07% < 70%",
    "✓ Условие 'd1' ВЫПОЛНЕНО: Объявлен гарантийный случай"
  ],
  "triggered_conditions": ["a", "b6", "d1"]
}
```

### GET /api/health
Проверка здоровья сервера

**Response (200 OK):**
```json
{
  "status": "ok"
}
```

---

## 🎨 UI Компоненты

### Drag-and-Drop зона
- Визуальная обратная связь при наведении
- Поддержка перетаскивания файлов
- Кнопка выбора файла (fallback)

### Результаты анализа
- **Информация о проекте**: название, код, период, местоположение
- **Статус проекта**: цветовая иконка (🟢/🟡/🔴) и название
- **Ключевые метрики**: СМР, отставание, ДДУ, гарантия
- **Обоснование**: пошаговое объяснение каждого условия

### История загрузок
- Список недавно загруженных отчетов
- Статус обработки (Completed/Processing)
- Информация о проекте из отчета

---

## 🚦 Статусы проекта

| Статус | Иконка | Условие | Цвет |
|--------|--------|---------|------|
| **Нормальный** | 🟢 | Все показатели в норме | Green |
| **Тревожный** | 🟡 | СМР < 80% ИЛИ ДДУ < 70% | Yellow |
| **Критичный** | 🔴 | Все критические условия | Red |

---

## ⚙️ Конфигурация

### Backend (api.py)
```python
UPLOAD_FOLDER = tempfile.gettempdir()  # Папка для временных файлов
MAX_FILE_SIZE = 50 * 1024 * 1024       # 50 MB максимум
ALLOWED_EXTENSIONS = {'pdf'}            # Только PDF
```

### Advanced Analyzer
```python
# Пороги классификации
SMR_CRITICAL = 80          # < 80% = критично
GPR_CRITICAL = 30          # > 30% = критично
DDU_CRITICAL = 70          # < 70% = критично
GUARANTEE = True           # Гарантийный случай = критично
```

---

## 🐛 Troubleshooting

| Проблема | Решение |
|----------|---------|
| `ModuleNotFoundError: No module named 'pdfplumber'` | `pip install pdfplumber` |
| API сервер не запускается | Проверьте порт 5000: `lsof -i :5000` |
| CORS ошибка при запросе | Убедитесь, что flask-cors установлен |
| PDF не анализируется | Проверьте формат PDF (должен быть текстовый, не сканированное изображение) |
| Frontend не подключается к API | Сервер должен отвечать на `http://localhost:5000/api/health` |

---

## 📊 Метрики и логирование

Добавить в api.py для отслеживания:

```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

logger.info(f"Анализирую файл: {filename}")
logger.error(f"Ошибка: {error_message}")
```

---

## 🌐 Развертывание

### Локально (разработка)
```bash
python3 api.py  # Flask dev server
```

### Production (Gunicorn)
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 api:app
```

### Docker
```bash
docker build -t build-view-hub-api .
docker run -p 5000:5000 build-view-hub-api
```

### Облако (AWS, Heroku, etc.)
1. Настроить environment переменные
2. Использовать Gunicorn вместо Flask dev server
3. Настроить CDN для статических файлов
4. Включить HTTPS

---

## 📖 Дополнительные ресурсы

- [Flask документация](https://flask.palletsprojects.com/)
- [pdfplumber на GitHub](https://github.com/jsvine/pdfplumber)
- [React документация](https://react.dev/)
- [Tailwind CSS документация](https://tailwindcss.com/)

---

## ✅ Чек-лист перед продакшеном

- [ ] Установлены все зависимости
- [ ] Backend запускается без ошибок
- [ ] Frontend подключается к API
- [ ] Тестирование с примерными PDF файлами (1.pdf, 2.pdf, 3.pdf)
- [ ] Обработка ошибок работает корректно
- [ ] Данные сохраняются в БД
- [ ] Логирование включено
- [ ] CORS правильно настроен
- [ ] Performance тестирование пройдено
- [ ] Security review проведен

---

## 💡 Следующие шаги

1. **Интеграция с Dashboards** - показывать статистику по статусам
2. **Интеграция с ProjectList** - фильтровать по статусу анализа
3. **История изменений** - отслеживать изменения статуса
4. **Уведомления** - отправлять алерты о критичных проектах
5. **Экспорт** - сохранять результаты в Excel/PDF
6. **Batch обработка** - анализировать несколько файлов одновременно

---

## 📝 История версий

**v1.0** (2 февраля 2026)
- ✅ Переход с ML-анализа на текстовый анализ PDF
- ✅ Реализована drag-and-drop загрузка
- ✅ API сервер с анализом метрик
- ✅ Классификация статуса проекта
- ✅ Полная документация

---

**Последнее обновление:** 2 февраля 2026  
**Автор:** Development Team  
**Статус:** ✅ Ready for Production
